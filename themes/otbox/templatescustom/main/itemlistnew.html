<?=Plugins::invokeEvent('onItemListRenderStatistics', array('categoryName' => $this->escape($GLOBALS['categoryInfo']['Name'])))?>

    <!--noindex-->
<style>
    .products-list .product-layout {
        border-right: 1px solid #eee;
        margin: 0 0 30px 0;
    }
    .products-list .product-grid .product-item-container {
        margin: 0;
    }
</style>
    <script type="text/javascript">
        var overid = 0;
        langs = {
            vendor_added_to_favourites: '<?=Lang::get('vendor_added_to_favourites')?>',
            vendor_removed_from_favourites: '<?=Lang::get('vendor_removed_from_favourites')?>'
        };

        function gettitle(lid) {
            if (lid != overid) return;
            var obj = $('#' + lid + ' ins.name');
            var li = obj.closest('li');
            if (li.data('title-loaded') || li.data('title-loading')) {
                return;
            }

            li.data('title-loading', true);
            $.ajax({
                url:'/?p=itemtitle&itemid=' + obj.attr('pid'),
                success:function (data) {
                    li.data('title-loading', false);
                    if (data && data.toString().length) {
                        obj.html(data);
                        obj.parent().attr('title', data);
                        li.find('.pic').attr('title', data);
                        li.data('title-loaded', true);
                    }
                },
                error:function (jqXHR, textStatus, errorThrown) {
                    obj.html('');
                }
            });
        }

        $(function () {

            // получение перевода убрано для оптимизации вызовов
            /*$('.product').mouseover(function () {
                if (overid != $(this).attr('id')) {
                    overid = $(this).attr('id');
                    setTimeout('gettitle("' + overid + '")', 1000);
                }
            });*/
            $('.product').mouseout(function () {
                overid = 0;
            });

            $("#dialog-form").dialog({
                autoOpen: false,
                modal: true,
                buttons : {
                    "Ок" : function() {
                        $("#dialog-form").dialog("close");
                    }
                }
            });
        });

        function showOverlay(){
            var h = $('#overlay').parent().height();
            $('#overlay').css({
                height: h+'px',
                display: 'block'
            });
        }
        function hideOverlay(){
            $('#overlay').hide();
        }
    </script>
    <!--/noindex-->

    <div id="dialog-form" title="<?=Lang::get('message')?>">
        <span id="basketinfo"></span>
    </div>

        <? if (!$no_search_request) { ?>
            <? if (!empty($currentImageUrl)) { ?>
                <div class="row old-search-content_image">
                    <div class="col-md-2">
                        <div class="search-img-wrapper">
                            <img src="<?=$currentImageUrl?>"/>
                        </div>
                    </div>
                    <div class="col-md-10">
                        <? $filters = RequestWrapper::get('filters'); ?>
                        <? foreach ($searchProperties as $searchProperty) { ?>
                            <? if ($searchProperty['IsCategory']) { ?>
                                <p><label class="panel-title"><?= $searchProperty['name'] ?></label></p>
                                <p>
                                    <? $filterId = $searchProperty['Id']; ?>
                                    <? foreach ($searchProperty['Values'] as $value) { ?>
                                        <?
                                        $filterValueId = $value['Id'];
                                        $active = (!is_null($filters) && isset($filters[$filterId]) && !empty($filters[$filterId][$filterValueId]));

                                        $url = clone $baseUrl;
                                        $newFilters = $filters;
                                        if ($active) {
                                            unset($newFilters[$filterId][$filterValueId]);
                                        } else {
                                            unset($newFilters[$filterId]);
                                            $newFilters[$filterId][$filterValueId] = 1;
                                        }
                                        $url = $url->SetValue('filters', $newFilters);

                                        ?>
                                        <a href="<?=$url->Get()?>" class="btn btn-default <?= $active ? 'active' : ''?>">
                                            <?= $active ? '<span class="glyphicon glyphicon-ok"></span>' : ''?>
                                            <?=$value['name']?>
                                        </a>
                                    <? }?>
                                </p>
                            <? } ?>
                        <? } ?>
                    </div>
                </div>
            <? } ?>
            <aside class="col-md-3 col-sm-4 col-xs-12 content-aside left_column sidebar-offcanvas ">
                <div id="overlay"></div>
                <span id="close-sidebar" class="fa fa-times"></span>
                <div class="module so_filter_wrap block-shopby">
                <? if ($vendorInfo) { ?>
                        <h3 class="modtitle"><?=Lang::get('about_vendor')?></h3>
                        <div class="mod-content box-category">
                        <ul>
                            <? if(!General::getConfigValue('hide_vendor_info_name')) { ?>
                                <li style="padding: 5px;">
                                    <?=Lang::get('name')?>: <b><?=$this->escape($vendorInfoFromDB['vendor_name'] ? $vendorInfoFromDB['vendor_name'] : $vendorInfo['name'])?></b>
                                </li>
                            <? }
                            if ($vendorInfo['shopname']) { ?>
                                <li style="padding: 5px;">
                                    <?=Lang::get('vendor_shop_name')?>: <b><?=$vendorInfo['shopname']?></b>
                                </li>
                            <? }
                            if ($vendorInfo['location']['city']) {
                                ?>
                                <li style="padding: 5px;">
                                    <?=Lang::get('placed_in')?>: <b><?=$vendorInfo['location']['city']?> (<?=$vendorInfo['location']['state']?>)</b>
                                </li>
                            <? }
                            if ($vendorInfo['location']['city']) {
                                ?>
                                <li style="padding: 5px;">
                                    <?=Lang::get('features')?>: <b><?=$vendorInfo['location']['city']?></b>
                                </li>
                            <? }
                            if ($vendorInfo['credit']['TotalFeedbacks']) {
                                ?>
                                <li style="padding: 5px;">
                                    <?=Lang::get('responses')?>: <b><?=$vendorInfo['credit']['TotalFeedbacks']?></b>
                                </li>
                            <? }
                            if ($vendorInfo['credit']['PositiveFeedbacks']) {
                                ?>
                                <li style="padding: 5px;">
                                    <?=Lang::get('positive')?>: <b><?=$vendorInfo['credit']['PositiveFeedbacks']?></b>
                                </li>
                            <? } ?>
                            <? if($vendorInfo['Scores']['deliveryscore']) { ?>
                                <li style="padding: 5px;">
                                    <?=Lang::get('delivery_score')?>:
                                        <b>
                                            <?=$vendorInfo['Scores']['deliveryscore']?>
                                        </b>
                                </li>
                            <? } ?>
                            <? if($vendorInfo['Scores']['itemscore']) { ?>
                                <li style="padding: 5px;">
                                    <?=Lang::get('item_score')?>:
                                        <b>
                                            <?=$vendorInfo['Scores']['itemscore']?>
                                        </b>
                                </li>
                            <? } ?>
                            <? if($vendorInfo['Scores']['servicescore']) { ?>
                                <li style="padding: 5px;">
                                    <?=Lang::get('service_score')?>:
                                        <b>
                                            <?=$vendorInfo['Scores']['servicescore']?>
                                        </b>
                                </li>
                            <? } ?>
                            <? if ($vendorInfo['credit']['level']) { ?>
                                <li style="padding: 5px;">
                                    <?=Lang::get('rating')?>:
                                    <img src="/i/hearts_gif/level_<?=$vendorInfo['credit']['level']?>.gif">
                                </li>
                            <? } ?>
                            <? if (isset($vendorInfo['FeaturedValues'])) { ?>
                                <? if (isset($vendorInfo['FeaturedValues']['ItemReviewRating'])) { ?>
                                    <li style="padding: 5px;">
                                        <?=Lang::get('ItemReviewRating')?>:
                                            <b>
                                                <?=$vendorInfo['FeaturedValues']['ItemReviewRating']?>
                                            </b>
                                    </li>
                                <? } ?>
                            <? } ?>
                            <li style="padding: 5px;">
                                    <button href="#" id="add-vendor-to-favourites" style="<?= $vendorInfo['favoriteItemId'] ? 'display:none;' : ''?>" vendorId="<?= $this->escape($vendorInfo['id']) ?>" class="button btn-add">
                                        <span><?=Lang::get('add_vendor_to_favourites')?></span>
                                    </button>
                                    <button href="#" id="vendor-added-to-favourites" style="<?= $vendorInfo['favoriteItemId'] ? '' : 'display:none;'?>" vendorId="<?= $this->escape($vendorInfo['id']) ?>" class="button btn-remove btn-delete-item " itemid="<?=$vendorInfo['favoriteItemId']?>">
                                        <span><?=Lang::get('drop_vendor_from_fav')?></span>
                                    </button>
                            </li>
                        </ul>
                        </div>
                <? } ?>
                <? if (RequestWrapper::getParamExists('filters') || RequestWrapper::getValueSafe('id') || RequestWrapper::getValueSafe('vid')) { ?>
                    <h3 class="modtitle"><?=Lang::get('active_cond')?></h3>
                    <div class="modcontent">
                        <ul id="clear-filter">
                            <? if (RequestWrapper::getParamExists('id') || RequestWrapper::getParamExists('vid')) { ?>
                                <li class="item">
                                    <div class="cat"> <?=Lang::get('vendor')?> </div>
                                    <div class="itemcat"><?=$this->escape($vendorInfoFromDB['vendor_name'] ? $vendorInfoFromDB['vendor_name'] : $vendorInfo['Id'])?></div>
                                </li>
                            <?}?>
                            <li class="item dropterms">
                                <a href="<?=$clearUrl?>" class="btn btn-default inverse">
                                    <?=Lang::get('reset_cond')?>
                                </a>
                            </li>
                        </ul>
                    </div>
                <? } ?>

                <?php
                /**
                 * @var UrlWrapper $baseUrl
                 * @var string $CurrentSearchType
                 * @var bool $IsProvider
                 * @var array $cachedSearchTypesInfo
                 */

                $pageUrl = clone $baseUrl;
                $allSearchTypes = isset($SearchTypes) && is_array($SearchTypes) && SCRIPT_NAME != 'vendor' ? $SearchTypes : array();
                $activeSearchTypes = array();
                $isMultiSearch = General::getConfigValue('use_multi_search') && $CurrentSearchType != 'Warehouse_Default';
                if (! empty($сategoryInfo['SearchMethod'])) {
                    $isMultiSearch = false;
                }
                foreach ($allFeatures as $feature) {
                    $pageUrl->DeleteKey($feature);
                }
                if($isMultiSearch) {
                    $activeSearchTypes[] = array(
                        'url' => $pageUrl->DeleteKey('Provider')->DeleteKey('SearchMethod')->Get(),
                        'title' => Lang::get('multisearch'),
                        'active' => !($IsProvider == 'active'),
                        'totalCount' => false,
                        'offset' => 0
                    );
                }
                foreach($allSearchTypes as $order => $searchType) {
                    $searchTypeInfo = ! empty($cachedSearchTypesInfo[$searchType['Provider'].'_'.$searchType['SearchMethod']]) ?
                        $cachedSearchTypesInfo[$searchType['Provider'].'_'.$searchType['SearchMethod']] : false;

                    $newPageUrl = clone $pageUrl;
                    $newSearchType = array(
                        'url' => $newPageUrl->DeleteKey('Provider')->DeleteKey('SearchMethod')->DeleteKey('filters')
                            ->Add('Provider', $searchType['Alias'])->Add('SearchMethod', $searchType['SearchMethod'])->Get(),
                        'title' => $searchType['DisplayName'],
                        'active' => (($CurrentSearchType == $searchType['Provider'].'_'.$searchType['SearchMethod'])
                                && !RequestWrapper::getValueSafe('Discount'))
                            || ($order == 0 && !$isMultiSearch && !$CurrentSearchType),
                        'totalCount' => $searchTypeInfo ? $searchTypeInfo['totalcount'] : false,
                        'offset' => 0
                    );
                    if (($CurrentSearchType == 'Warehouse_Default') and ($searchType['Provider'].'_'.$searchType['SearchMethod'] != 'Warehouse_Default')) {
                        continue;
                    }
                    if (($newSearchType['totalCount'] === false && $searchType['Provider'].'_'.$searchType['SearchMethod'] != 'Warehouse_Default')
                        || $newSearchType['totalCount'] > 0) {
                        if (empty($сategoryInfo['SearchMethod']) || ($CurrentSearchType == $searchType['Provider'].'_'.$searchType['SearchMethod'])) {
                            $activeSearchTypes[] = $newSearchType;
                        }
                    }
                    if (! empty($searchType['Features'])) {
                        foreach($searchType['Features'] as $feature) {
                            if ($feature['CanBeTrue'] == 'true') {
                                $plusText = $feature['CanBeFalse'] == 'true' ? ' +' : '';
                                if (empty($сategoryInfo['SearchMethod']) || ($CurrentSearchType == $searchType['Provider'].'_'.$searchType['SearchMethod'])) {
                                    $activeSearchTypes[] = array(
                                        'url' => $pageUrl->Add($feature['Name'], 'true')->Get(),
                                        'urlWithoutFeature' => $pageUrl->DeleteKey($feature['Name'])->Get(),
                                        'title' => ! empty($feature['ForTrue']) ? $feature['ForTrue'] : $feature['DisplayName'] . $plusText,
                                        'active' => RequestWrapper::getValueSafe($feature['Name']) && ($CurrentSearchType == $searchType['Provider'].'_'.$searchType['SearchMethod']),
                                        'totalCount' => false,
                                        'offset' => 1,
                                        'css' => 'feature-' . $feature['Name'],
                                    );
                                }
                            }
                            if ($feature['CanBeFalse'] == 'true') {
                                $plusText = $feature['CanBeTrue'] == 'true' ? ' -' : '';
                                $activeSearchTypes[] = array(
                                    'url' => $pageUrl->Add($feature['Name'], 'false')->Get(),
                                    'urlWithoutFeature' => $pageUrl->DeleteKey($feature['Name'])->Get(),
                                    'title' => ! empty($feature['ForFalse']) ? $feature['ForFalse'] : $feature['DisplayName'] . $plusText,
                                    'active' => RequestWrapper::getValueSafe($feature['Name']),
                                    'totalCount' => false,
                                    'offset' => 1,
                                    'css' => 'feature-' . $feature['Name'],
                                );
                            }
                        }
                    }
                }
                ?>
                <? if(count($activeSearchTypes) > 0  && ! $vendorInfo ){ ?>
                        <h3 class="modtitle"><?=Lang::get('supplier_type')?></h3>
                        <div class="modcontent">
                        <ul>
                            <?php foreach($activeSearchTypes as $type) { ?>
                                <li class="item">
                                    <a class="<?=$type['active'] ? 'active' : ''?> <?=$type['offset']==1 ? 'isFeature' : 'noFeature';?> <?= (!empty($type['css'])) ? $type['css'] : '' ?>"
                                       href="<?=$type['active'] ? $type['urlWithoutFeature'] : $type['url']?>">
                                        <?=$type['title']?>
                                        <? if ($type['totalCount'] !== false) { ?>
                                            (<span style="font-size:10px;">
                                <?=$type['totalCount']?>
                            </span>)
                                        <? } ?>
                                    </a>
                                    <? if (($type['offset']==1) && ($type['active'])) { ?>
                                        <a href="<?=$type['urlWithoutFeature']?>" class="i-new i-delete  i delete go"></a>
                                    <? } ?>
                                </li>
                            <?php } ?>
                        </ul>
                        </div>
                <? } ?>

                <? if (isset($subCategories) && is_array($subCategories) && count($subCategories)) { ?>
                    <h3 class="modtitle"><?=Lang::get('subcategories')?></h3>
                    <div class="modcontent">
                        <ul>
                            <? if (! empty($prevCategoryLink)) { ?>
                                <li class="item">
                                    <a <?=(!isset($cid) || $cid == '' ? 'class="active"' : '')?>
                                        href="<?=$prevCategoryLink?>"><?=Lang::get('all_categories')?></a>
                                </li>
                            <? } ?>

                            <? if (SCRIPT_NAME == 'search' || SCRIPT_NAME == 'item_list_ajax' || SCRIPT_NAME == 'vendor') {
                                $cid = RequestWrapper::getValueSafe('cid');
                                $hasHidden = false;
                                foreach ($subCategories as $k => $category) {
                                    if ($k < 10) {
                                        if (RequestWrapper::getValueSafe('Provider')) {
                                            $url = $baseUrl->DeleteKey('cid')->Add('Provider', RequestWrapper::getValueSafe('Provider'))->Add('SearchMethod', RequestWrapper::getValueSafe('SearchMethod'))->Get();
                                        } else {
                                            $url = $baseUrl->DeleteKey('Provider')->DeleteKey('SearchMethod')->DeleteKey('cid')->Get();
                                        } ?>
                                        <li class="item">
                                            <a href="<?=UrlGenerator::generateFullSearchUrl($url,$category['id'],$tmall,RequestWrapper::getValueSafe('Discount')); ?>" <?=($category['id'] == $cid ? 'class="active"' : '')?>>
                                                <?=$this->escape($category['name']);?> <? if ($category['itemcount']) { ?>(<?= $category['itemcount'] ?>) <? } ?>
                                            </a>
                                        </li>
                                    <? } else { ?>
                                        <? $hasHidden = true; ?>
                                        <li class="item left-category-hidden">
                                            <a href="<?=UrlGenerator::generateFullSearchUrl($url,$category['id'],$tmall,RequestWrapper::getValueSafe('Discount')); ?>" <?=($category['id'] == $cid ? 'class="active"' : '')?>>
                                                <?=$this->escape($category['name']);?> <? if ($category['itemcount']) { ?>(<?= $category['itemcount'] ?>) <? } ?>
                                            </a>
                                        </li>
                                    <? } ?>
                                <? } ?>
                                <? if ($hasHidden) { ?>
                                    <li class="item last">
                                        <a href="#" class="dotted" onclick="$('.left-category-hidden').show();$(this).remove();return false;">
                                            <i class="i-new i-arrow-down i arrowdown"></i><span><?=Lang::get('other_cats')?></span>
                                        </a>
                                    </li>
                                <? } ?>
                            <? } ?>

                            <? if (SCRIPT_NAME == 'subcategory' || SCRIPT_NAME == 'category') {
                                $hasHidden = false;
                                foreach ($subCategories as $k => $cat) {
                                    if ($k >= 10) {
                                        $classLink = 'class="item left-category-hidden"';
                                    }
                                    if (RequestWrapper::getValueSafe('Provider')) {
                                        $cat['Provider'] = RequestWrapper::getValueSafe('Provider');
                                        $cat['SearchMethod']= RequestWrapper::getValueSafe('SearchMethod');
                                    }
                                    if (!isset($cat['ishidden']) || $cat['ishidden'] == 'false') {
                                        if (!isset($cat['isparent']) || $cat['isparent'] == 'false') { ?>
                                            <li <?=$classLink?>>
                                                <a href="<?=UrlGenerator::generateFullCatUrl('category',$cat,$tmall,RequestWrapper::getValueSafe('Discount'))?>"><?=$this->escape($cat['name'])?></a>
                                            </li>
                                        <? } else { ?>
                                            <li <?=$classLink?>>
                                                <a href="<?=UrlGenerator::generateFullCatUrl('subcategory',$cat,$tmall,RequestWrapper::getValueSafe('Discount'))?>"><?=$this->escape($cat['name'])?></a>
                                            </li>
                                        <? } ?>
                                    <? } ?>
                                <? } ?>
                                <? if (count($subCategories) > 10) { ?>
                                    <li class="item last">
                                        <a href="#" class="dotted" onclick="$('.left-category-hidden').show();$(this).remove();return false;">
                                            <i class="i-new i-arrow-down i arrowdown"></i><span><?=Lang::get('other_cats')?></span>
                                        </a>
                                    </li>
                                <? } ?>
                            <? }?>
                        </ul>
                    </div>
                <? } ?>


                    <? if (isset($hintcats) && count($hintcats) > 0) { ?>
                        <h3 class="modtitle"><?=Lang::get('Perhaps_you_are_interested')?></h3>
                        <div class="modcontent">
                            <ul>
                                <?
                                $cid = RequestWrapper::getValueSafe('cid');
                                $hasHidden = false;
                                ?>
                                <? foreach ($hintcats as $k => $category) { ?>
                                    <? if ($k < 10) { ?>
                                        <li class="item" <?=($cat['id'] == $cid ? 'class="active"' : '')?>>
                                            <a href="<?=General::generateUrl('subcategory', $category)?>"><?=$this->escape($category['name']);?></a>
                                        </li>
                                        <?
                                    } else {
                                        $hasHidden = true;
                                        ?>
                                        <li class="fast-category-hidden">
                                            <a href="/?p=category&cid=<?=$category['id'];?>"> <?=$this->escape($category['name']);?></a>
                                        </li>
                                    <? } ?>
                                <? } ?>
                                <? if ($hasHidden) { ?>
                                    <li class="item last">
                                        <a href="#" class="dotted" onclick="$('.fast-category-hidden').show();$(this).remove();return false;">
                                            <i class="i-new i-arrow-down i arrowdown"></i><span><?=Lang::get('other_cats')?></span>
                                        </a>
                                    </li>
                                <? } ?>
                            </ul>
                        </div>
                    <? } ?>


                    <?=$SearchProp?>
                </div>
            </aside>

            <div id="content" class="col-md-9 col-sm-12 col-xs-12 fluid-sidebar">
                <div class="products-category clearfix">
                <? if (!empty($_GET['search'])) { ?>
                    <h3 class="title-category "><span><?=Lang::get('search_results')?></span> «<?=RequestWrapper::getValueSafe('search')?>» <?=$GLOBALS['TranslatedItemTitle']? '('.Lang::get('translation'). '«'.$GLOBALS['TranslatedItemTitle'].'»)' : '' ?></h3>
                <? } elseif (!empty($_GET['brand'])) { ?>
                    <h3 class="title-category "><span><?=Lang::get('search_results')?></span></h3>
                <? } ?>
                <? if($GLOBALS['categoryInfo']['Name']) { ?>
                    <h3 class="title-category "><?=$this->escape($GLOBALS['categoryInfo']['Name'])?></h3>
                <? } ?>
                <? if (@$GLOBALS['brandinfo']) { ?>
                    <div class="wrap clrfix brand-info">
                        <i><img src="<?=$GLOBALS['brandinfo']['PictureUrl']?>" style="float:left; margin: 0 10px 10px 0"/></i>
                        <?=$GLOBALS['brandinfo']['Description']?>
                    </div>
                <? } ?>
                    <div class="product-filter product-filter-top filters-panel">
                        <div class="row">
                            <div class="col-sm-5 view-mode">
                                <a href="javascript:void(0)" class="open-sidebar hidden-lg hidden-md"><i class="fa fa-bars"></i> <?=Lang::get('sidebar')?></a>
                                <div class="sidebar-overlay "></div>
                                <div class="list-view hidden-xs">
                                    <? if ($IsProvider) { ?>
                                    <div class="btn btn-gridview">
                                        <?=Lang::get('shown')?>: <?=Lang::get('from')?> <b><?=($count ? $from + 1 : 0)?></b> <?=Lang::get('to')?>
                                        <b><? if ($from + $perpage < $count) print $from + $perpage; else print $count; ?></b>
                                        <?=Lang::get('from2')?>
                                        <b><?=$count?></b>
                                    </div>
                                    <? } ?>
                                </div>
                            </div>

                            <div class="short-by-show form-inline text-right col-md-7 col-sm-7 col-xs-12 hidden-xs">
                                <div class="form-group short-by">
                                    <? if (isset($availableSorts) && ! empty($availableSorts)) { ?>
                                            <form method="post" id="sort_form">
                                                <label class="control-label"><?=Lang::get('sort_by')?>: </label>

                                                <? if (! empty($availableSorts)) { ?>
                                                    <select name="sort_by" class="form-control" onchange="document.getElementById('sort_form').submit();">
                                                        <? foreach ($availableSorts as $sort) { ?>
                                                            <option value="<?=$sort['OrderBy']?>" <?if ($currentSort == $sort['OrderBy']) { ?>selected<? }?>><?=$sort['DisplayName']?></option>
                                                        <? } ?>
                                                    </select>
                                                <? } ?>
                                            </form>
                                    <? } ?>
                                </div>
                                <div class="form-group">
                                    <? if ($IsProvider) { ?>
                                        <?php
                                        if (! isset($pp)) {
                                            $pp = array(20, 40, 100);
                                        }
                                        $ppValue = $perpage;
                                        if (!in_array($ppValue, $pp)) {
                                            $pp[] = $ppValue;
                                            asort($pp);
                                        }
                                        ?>
                                        <form method="post" id="per_page">
                                            <label class="control-label" for="input-limit"><?=Lang::get('show')?>: </label>
                                            <select name="per_page" class="form-control" onchange="document.getElementById('per_page').submit();">
                                                <?php foreach ($pp as $key => $value) {
                                                    if ($maxFrameSize && $value > $maxFrameSize ) {
                                                        continue;
                                                    }
                                                    ?>
                                                    <option value="<?=$value?>" <?if ($perpage == $value){?>selected<?}?>><?=$value?></option>
                                                <?php } ?>
                                            </select>
                                        </form>
                                    <? } ?>
                                </div>
                            </div>

                        </div>
                    </div>


                <? if (! empty($itemlist)) { ?>
                    <div class="products-list row nopadding-xs so-filter-gird">
                        <? if (in_array('Seo2', General::$enabledFeatures)) {
                            $url = '/item?';
                        } else {
                            $url = '/?p=item&';
                        } ?>
                        <? foreach ($itemlist as $idx => $item) { ?>
                            <? $itemTitile = (! empty($item['Title'])) ? $this->escape($item['Title']) : $this->escape($item['VendorName']); ?>

                            <? if ((General::getConfigValue('hide_item_for_restrictions')) && ($item['IsSellAllowed'] === 'false') && ($item['SellDisallowReason'] === 'IsFiltered')) { ?>
                                <?=View::fetchTemplate('item-replace-text', 'item_replace_text', '/blocks/search/', array('text' => Lang::get('IsFiltered')))?>
                            <? } elseif ($item['ErrorCode'] == 'Ok') { ?>
                                <? $paramsByItemUrl = array('vendorId' => $item['VendorId']); ?>
                                <? if ($GLOBALS['categoryInfo']['IsSearch'] && $GLOBALS['categoryInfo']['IsSearch'] == 'true') { ?>
                                    <? $paramsByItemUrl['cid'] = $GLOBALS['categoryInfo']['id']; ?>
                                <? } ?>
                                <? $itemUrl = UrlGenerator::generateItemUrl($item['id'], $paramsByItemUrl);                ?>
                                <div class="product-layout product-grid product-grid-4 col-lg-3 col-md-4 col-sm-6 col-xs-6<?if ($item['IsSellAllowed'] === 'false') { ?> is-sell-allowed-false<? } ?> <?=ProductsHelper::formatFeatureListForCss($item['Features'])?>" id="product<?=$idx?>" title="<?=$this->escape($item['title'])?>" style="position:relative;">
                                    <div class="product-item-container">
                                        <div class="left-block">
                                            <?=ProductsHelper::getHtmlFeatureListForLabel($item['Features'])?>
                                            <a href="<?=$itemUrl?>" title="<?=$itemTitile?>">
                                            <div class="product-image-container">
                                                <?if (ProductsHelper::getMediumImage($item)) { ?>
                                                    <img src="<?= ProductsHelper::getMediumImage($item) ?>" class="img-responsive">
                                                <?}?>
                                            </div>
                                            </a>
                                            <?
                                            if ((count($item['PromotionPrice'])>0) and (!General::getSiteConfig('hide_discont_lists'))) {
                                                $skidka = (((int)($item['PromotionPrice'][0]['Val']))/((int)($item['convertedpricewithoutsign'])));
                                                $skidka = 1 - $skidka;
                                                $skidka = $skidka * 100;
                                                $skidka = round($skidka,0);
                                                //
                                                if ($skidka > 0)
                                                {
                                                    ?>
                                                    <div class="box-label">
                                                        <span class="label-product label-sale">-<?=$skidka?>%</span>
                                                    </div>
                                                <? } } ?>
                                        </div>
                                        <div class="right-block">
                                            <h4><a href="<?=$itemUrl?>"><?=$itemTitile?></a></h4>
                                            <div class="rate-history">
                                                <div class="ratings">
                                                    <div class="rating-box">
                                                        <? if ( isset($item['vendorscore']) && $item['vendorscore'] > 0) { ?>
                                                        <img src="/i/hearts_gif/level_<?=$item['vendorscore']?>.gif">
                                                        <? } ?>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="price">
                                                <? if (count($item['PromotionPrice'])>0) { ?>
                                                    <span class="price-new"><?=General::getCurrencyPromoPrice($item)?></span>
                                                    <span class="price-old"><?=General::getCurrencyPrice($item)?></span>
                                                <? }else{ ?>
                                                    <span class="price-new"><?=General::getCurrencyPrice($item)?></span>
                                                <? } ?>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            <? } else { ?>
                                <?=View::fetchTemplate('item-error-code', 'item', '/blocks/search/', array('item' => $item))?>
                            <? } ?>
                        <? } ?>
                    </div>
                    <? } else { ?>
                    <h2><span><?=Lang::get('nothing_found')?></span></h2>
                <? } ?>


                <? if(Session::checkErrors()){ ?>
                    <?
                    $errorCode = Session::getErrorCode();
                    $subErrorCode = Session::getSubErrorCode();
                    $errorDescription = Session::getErrorDescription();
                    ?>
                    <? if ($errorCode === 'NotAvailable' && $subErrorCode === 'External_ProviderTemporaryUnavailable') { ?>
                        <h2 class="item-list-error"><?=Lang::get('SearchErrorProviderTemporaryUnavailable')?></h2>
                    <? } else if(Lang::get('Search:' . $errorCode) == 'Search:'.$errorCode) { ?>
                        <h2 class="item-list-error"><?=$errorCode?></h2>
                        <strong><?=$errorDescription?></strong>
                    <? } else { ?>
                        <h2 class="item-list-error"><?=Lang::get('Search:'.$errorCode)?></h2>
                    <? } ?>
                <? } ?>

                <? if (! $checkMultiSearch) { ?>
                    <?
                    $cid = RequestWrapper::getValueSafe('cid');
                    if($cid)
                        $baseUrl->Add('cid', $cid);
                    $baseUrl->DeleteKey('Provider')->DeleteKey('SearchMethod');
                    if (RequestWrapper::getValueSafe('Provider'))
                        $baseUrl->Add('Provider', RequestWrapper::getValueSafe('Provider'))->Add('SearchMethod', RequestWrapper::getValueSafe('SearchMethod'));
                    if (RequestWrapper::getValueSafe('Discount'))
                        $baseUrl->Add('Discount', 'true');
                    ?>
                    <? $page_count_print = General::getConfigValue('pager_count_print') ? General::getConfigValue('pager_count_print') : '2'; ?>
                    <? $curpage = floor($from / $perpage) + 1 ?>
                    <?
                    if (isset($lastSearchProvider) && $lastSearchProvider['totalCount'] >= 20) {
                        $maxpage = $maximumPageCount; //ceil($lastSearchProvider['totalCount'] / $perpage) > 40 ? 40 : ceil($lastSearchProvider['totalCount'] / $perpage);
                        $baseUrl->DeleteKey('Provider')->DeleteKey('SearchMethod');
                        $lastProvider = explode("_", $lastSearchProvider['key']);
                        $baseUrl->Add('Provider', $lastProvider[0])->Add('SearchMethod', $lastProvider[1]);
                    } else {
                        $maxpage = $maximumPageCount;
                        //$maxpage = ceil($maxCountPagination / $perpage);
                    }

                    ?>
                        <? if ($maxpage > 1) { ?>
                            <ul class="pagination">
                                <? if ($curpage != 1) { ?>
                                    <li class="pagination_prev"><a href="<?=$baseUrl->DeleteKey('from')->Add('from',$from - $perpage)->Get()?>">&laquo;</a></li>
                                <? } ?>

                                <? if ($curpage > ($page_count_print + 1)) { ?>
                                    <li><a href="<?=$baseUrl->DeleteKey('from')->Add('from',0)->Get()?>">1</a></li>
                                <? } ?>
                                <? if ($curpage > ($page_count_print + 2)) { ?>
                                    <li class="pagination_skip disabled"><a href="javascript:void(0)"></a></li>
                                <? } ?>
                                <? for ($i = max(1, $curpage - $page_count_print); $i <= min($maxpage, $curpage + $page_count_print); $i++) { ?>
                                    <? if ($curpage == $i) { ?>
                                        <li class="active"><a href="<?=$baseUrl->DeleteKey('from')->Add('from',($i - 1) * $perpage)->Get()?>"><?=$i?></a></li>
                                    <? } else { ?>
                                        <li><a href="<?=$baseUrl->DeleteKey('from')->Add('from',($i - 1) * $perpage)->Get()?>"><?=$i?></a></li>
                                    <? } ?>
                                <? } ?>
                                <? if ($curpage < $maxpage - ($page_count_print + 1)) { ?>
                                    <li class="pagination_skip disabled"><a href="javascript:void(0)">...</a></li>
                                <? } ?>
                                <? if ($curpage < $maxpage - $page_count_print) { ?>
                                    <li><a href="<?=$baseUrl->DeleteKey('from')->Add('from',($maxpage - 1) * $perpage)->Get()?>"><?=$maxpage?></a></li>
                                <? } ?>

                                <? if ($maxpage > 1 && !($curpage >= $maxpage)) { ?>
                                    <li class="pagination_next"><a href="<?=$baseUrl->DeleteKey('from')->Add('from',$from + $perpage)->Get()?>">&raquo;</a></li>
                                <? } ?>
                            </ul>
                        <? } ?>
                <? } ?>
                </div>
            </div>

        <? } else { ?>
            <h2><span><?=Lang::get('No_search_reason_' . $no_search_request_reason)?></span></h2>
        <?} ?>
    <script src="js/itemListFilters.js?<?=CFG_SITE_VERSION;?>"></script>
<?=Plugins::invokeEvent('onItemListCustom')?>
<? if (isset ($_COOKIE['ftitle'])&&$_COOKIE['ftitle']=='closed'):?>
    <!--noindex-->
    <script>
        $(function(){
            $('.ftitle').click();
        });
    </script>
    <!--/noindex-->
<?endif;?>